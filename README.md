# kubernetes-config

Travis services running on Kubernetes!

This repo contains configuration for all of the Kubernetes services that we run for Travis CI. Currently, we're only using this for our macOS-based infrastructure running on MacStadium.

This repo does not provision the actual Kubernetes cluster that the services run on. For that, see the [terraform-config](https://github.com/travis-ci/terraform-config) repo.

## Requirements

* kubectl
* Ruby 2.2 or higher (to make sure trvs functions correctly)

## Organization

This repository is organized very similarly to our `terraform-config` repository. Different environments are separated into top-level directories with names matching the Terraform graph directory that provisions the cluster (e.g. `macstadium-staging`).

Each environment directory contains the following:

* `Rakefile`, which pulls in the common `rake` tasks from `rakelib/environment.rb`
* `env.yml`: an environment configuration file that defines modules to import and secrets to generate
* `templates/` (optional): a directory containing static `.yaml` files defining Kubernetes resources specific to the environment

There is a top-level modules directory that contains reusable sets of resources that can be customized for the environment where they are used.

## Set-up

Services are deployed to Kubernetes via `kubectl apply`. The build process expects your default `KUBECONFIG` file to have a context named the same as the directory whose services you are trying to deploy.

You can configure such a context automatically from the `terraform-config` repo by running `make context` from the appropriate graph directory. This should only need to be done once per development machine, unless the cluster master has to be rebuilt for some reason.

## Usage

This repo uses a `rake`-based build system to collect and generate the Kubernetes resources that will be applied.

### Planning changes

To generate the .yaml files that will be applied for an environment, use `rake plan` from the environment directory:

```
macstadium-staging$ rake plan
```

This will do the following steps:

* Generate Kubernetes secret resources based on secrets generated by `trvs`
* Copy resources in `templates/` into the `build/` directory
* Generate resources from any modules the environment uses by rendering the module's templates

All of the resources for the environment can then be found in `build/`. You can inspect them if needed.

### Applying changes

To create and update the resources on the actual Kubernetes cluster, run `rake apply`:

```
macstadium-staging$ rake apply
```

This will first apply all of the secrets, then any module resources, and finally any environment-specific resources. The output from `kubectl` should indicate whether a given resource was changed or not.

If you haven't already run `rake plan`, then the necessary resources will be generated when you `apply`.

## Kubernetes Dashboard

Our clusters are running [kubernetes-dashboard](https://github.com/kubernetes/dashboard), which makes it easy to what's going on in the cluster without having to run a bunch of `kubectl` commands.

* [macstadium-prod-1](https://cluster-1-master.macstadium-us-se-1.travisci.net:31000/#!/overview?namespace=macstadium-prod-1)
* [macstadium-staging](https://cluster-staging-master.macstadium-us-se-1.travisci.net:31000/#!/overview?namespace=macstadium-staging)
